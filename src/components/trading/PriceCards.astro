---
// Crypto Price Cards with GSAP animations
const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:3001';
const featured = ['btcusd', 'ethusd', 'solusd', 'xrpusd'];
---

<div class="section gap-y-10 py-20">
	<div class="col-span-full text-center px-4">
		<h2 class="text-3xl md:text-4xl font-bold mb-2">Live Market Prices</h2>
		<p class="text-white/60">Real-time data from ChainFlow Inter-Routing Engine</p>
	</div>

	<div class="col-span-full px-4">
		<div id="price-cards-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 max-w-6xl mx-auto">
			{featured.map(symbol => (
				<a href={`/symbol/${symbol}`} data-card={symbol} class="price-card relative overflow-hidden rounded-xl border border-white/10 bg-gradient-to-br from-white/5 to-white/2 p-6 backdrop-blur cursor-pointer transition-all hover:border-white/20 hover:scale-105 block">
					<div class="flex items-start justify-between mb-4">
						<div>
							<img data-logo={symbol} class="w-10 h-10 rounded-full mb-2" alt={symbol} />
							<h3 class="font-bold text-lg uppercase">{symbol.replace('usd', '')}</h3>
							<p class="text-white/50 text-sm">USD</p>
						</div>
						<svg class="price-arrow w-6 h-6 opacity-0" viewBox="0 0 24 24" fill="none">
							<path d="M12 4L12 20M12 4L6 10M12 4L18 10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
						</svg>
					</div>
					
					<div class="space-y-2">
						<div data-price={symbol} class="text-3xl font-bold font-mono">--</div>
						<div class="flex items-center gap-2">
							<span data-change={symbol} class="change-badge text-sm font-medium px-2 py-1 rounded">--</span>
							<span data-volume={symbol} class="text-white/50 text-xs">Vol: --</span>
						</div>
					</div>
					
					<!-- Animated background gradient -->
					<div class="absolute inset-0 bg-gradient-to-tr from-transparent via-white/5 to-transparent opacity-0 glow-effect"></div>
				</a>
			))}
		</div>
	</div>
</div>

<style>
	.price-card {
		position: relative;
		transition: transform 0.2s ease, border-color 0.3s ease;
	}
	
	.price-card:hover {
		transform: translateY(-4px);
		border-color: rgba(255, 255, 255, 0.2);
	}
	
	.change-badge.positive {
		background: rgba(16, 185, 129, 0.2);
		color: #10b981;
	}
	
	.change-badge.negative {
		background: rgba(239, 68, 68, 0.2);
		color: #ef4444;
	}
	
	.price-arrow.up {
		color: #10b981;
		transform: rotate(0deg);
	}
	
	.price-arrow.down {
		color: #ef4444;
		transform: rotate(180deg);
	}
	
	.glow-effect {
		pointer-events: none;
	}
</style>

<script>
	import { gsap } from "gsap";
	import { ScrollTrigger } from "gsap/ScrollTrigger";
	
	gsap.registerPlugin(ScrollTrigger);
	
	// Get API URL - uses proxy endpoint if PUBLIC_API_URL not set
	const API_URL = import.meta.env.PUBLIC_API_URL || (window.location.hostname === 'localhost' ? '/api/proxy' : 'https://dashboard.paxeer.app');
	const featured = ['btcusd', 'ethusd', 'solusd', 'xrpusd'];

	let previousPrices = {};

	async function updatePrices() {
		try {
			const symbolsQuery = featured.join(',');
			const controller = new AbortController();
			const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
			
			const res = await fetch(`${API_URL}/api/v1/quotes?symbols=${symbolsQuery}`, {
				signal: controller.signal
			});
			clearTimeout(timeoutId);
			
			if (!res.ok) {
				throw new Error(`HTTP ${res.status}`);
			}
			
			const data = await res.json();
			
			featured.forEach(symbol => {
				const quote = data[symbol];
				if (!quote) return;
				
				const card = document.querySelector(`[data-card="${symbol}"]`);
				const priceEl = document.querySelector(`[data-price="${symbol}"]`);
				const changeEl = document.querySelector(`[data-change="${symbol}"]`);
				const volumeEl = document.querySelector(`[data-volume="${symbol}"]`);
				const logoEl = document.querySelector(`[data-logo="${symbol}"]`);
				const arrowEl = card?.querySelector('.price-arrow');
				const glowEl = card?.querySelector('.glow-effect');
				
				if (logoEl && quote.logo) {
					logoEl.src = quote.logo;
				}
				
				if (priceEl) {
					const oldPrice = previousPrices[symbol];
					const newPrice = quote.last;
					
					// Animate price update
					gsap.to(priceEl, {
						duration: 0.3,
						scale: 1.05,
						onComplete: () => {
							priceEl.textContent = `$${newPrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
							gsap.to(priceEl, { duration: 0.2, scale: 1 });
						}
					});
					
					// Show direction arrow
					if (oldPrice && arrowEl) {
						arrowEl.classList.remove('up', 'down');
						if (newPrice > oldPrice) {
							arrowEl.classList.add('up');
							gsap.to(glowEl, { opacity: 0.3, duration: 0.3, yoyo: true, repeat: 1 });
						} else if (newPrice < oldPrice) {
							arrowEl.classList.add('down');
						}
						gsap.to(arrowEl, { opacity: 1, duration: 0.2 });
						gsap.to(arrowEl, { opacity: 0, duration: 0.2, delay: 1.5 });
					}
					
					previousPrices[symbol] = newPrice;
				}
				
				if (changeEl) {
					const change = ((quote.last - quote.open) / quote.open * 100);
					changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
					changeEl.className = `change-badge ${change >= 0 ? 'positive' : 'negative'}`;
				}
				
				if (volumeEl && quote.volume) {
					volumeEl.textContent = `Vol: ${(quote.volume / 1000000).toFixed(2)}M`;
				}
			});
		} catch (error) {
			console.error('Failed to fetch prices:', error);
		}
	}

	function init() {
		// Animate cards on scroll
		gsap.from('.price-card', {
			scrollTrigger: {
				trigger: '#price-cards-grid',
				start: 'top 80%',
				toggleActions: 'play none none reverse',
			},
			duration: 0.6,
			opacity: 0,
			y: 30,
			stagger: 0.1,
		});
		
		// Fetch prices immediately and every 3 seconds
		updatePrices();
		setInterval(updatePrices, 3000);
	}

	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', init);
	} else {
		init();
	}
</script>
